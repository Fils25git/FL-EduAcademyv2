<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="form-container">
        <h2>Edit Your Profile</h2>
        <form id="edit-profile-form">
            <img id="profile-picture" src="https://i.imgur.com/TV9o8j1.png" alt="Profile Picture">

<!-- Hidden File Upload Input -->
<input type="file" id="profile-pic-input" style="display:none;" accept="image/*">
          <!--  <button id="upload-btn">update profile picture</button>-->
            <p id="upload-message"></p>
            <label for="first-name">First Name:</label>
            <input type="text" id="first-name" required>

            <label for="middle-name">Middle Name (optional):</label>
            <input type="text" id="middle-name">

            <label for="last-name">Last Name:</label>
            <input type="text" id="last-name" required>

            <label for="school">School Name:</label>
            <input type="text" id="school" required>

            <label for="class">Class:</label>
            <input type="text" id="class" required>

            <label for="age">Age:</label>
            <input type="number" id="age" required>

            <label for="district">District (City):</label>
            <input type="text" id="district" required>

            <label for="parent-phone">Parent's Phone Number:</label>
            <input type="tel" id="parent-phone" required>

            <button type="submit">Save Changes</button>
        </form>
        <p id="message" style="color: green;"></p>
    </div>
</body>
   <script>
    // Get elements
    const profilePicture = document.getElementById("profile-picture");
    const fileInput = document.getElementById("profile-pic-input");

    // When the profile picture is clicked, open file input
    profilePicture.addEventListener("click", function() {
        fileInput.click();
    });

    // When a new file is selected, upload automatically
    fileInput.addEventListener("change", async function(event) {
        const file = event.target.files[0]; // Get the selected file
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePicture.src = e.target.result; // Update profile picture preview
            };
            reader.readAsDataURL(file);

            // Call the function to upload the file to Supabase
            await uploadProfilePicture(file);
        }
    });

    // Function to handle file upload to Supabase Storage
    async function uploadProfilePicture(file) {
        const userId = localStorage.getItem("user_id") || sessionStorage.getItem("user_id");

        if (!userId) {
            alert("You must be logged in to update your profile.");
            return;
        }

        const fileName = `profile_pictures/${Date.now()}_${file.name}`;

        try {
            // Upload the file to Supabase Storage
            const { data, error } = await supabase.storage
                .from("profile-pictures")
                .upload(fileName, file, { contentType: file.type });

            if (error) {
                throw new Error("Upload failed: " + error.message);
            }

            // Get the public URL of the uploaded file
            const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/profile-pictures/${fileName}`;

            // Update the profile picture URL in the database
            const { error: updateError } = await supabase
                .from("learners_list")
                .update({ profile_picture: imageUrl })
                .eq("user_id", userId);

            if (updateError) {
                throw new Error("Failed to update profile picture in the database.");
            }

            // Update the profile picture preview with the new URL
            profilePicture.src = imageUrl;
            alert("Profile picture updated successfully!");

        } catch (error) {
            console.error("Error:", error);
            alert("Error uploading profile picture.");
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script type="module" src="/js/editProfile.js"></script>
</html>
